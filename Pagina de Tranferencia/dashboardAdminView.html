<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - SMS Rio Preto</title>
    <link rel="stylesheet" href="css/formulario.css">
    <link rel="stylesheet" href="css/dashboardAdminView.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .status-mini { display:inline-block;padding:3px 10px;border-radius:50px;font-size:.75rem;font-weight:700;white-space:nowrap; }
        .badge-em-analise  { background:#fff3cd;color:#856404; }
        .badge-deferido    { background:#d4edda;color:#155724; }
        .badge-indeferido  { background:#f8d7da;color:#721c24; }
        .badge-contemplado { background:#cce5ff;color:#004085; }
        .status-badge.deferido    { background:#d4edda;color:#155724; }
        .status-badge.indeferido  { background:#f8d7da;color:#721c24; }
        .status-badge.em-analise  { background:#fff3cd;color:#856404; }
        .status-badge.contemplado { background:#cce5ff;color:#004085; }
        /* Busca an√°lise */
        .analise-toolbar { display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;align-items:flex-end; }
        .analise-toolbar input { flex:1;min-width:220px;padding:11px 16px;border:1px solid #d1d9e0;border-radius:8px;font-size:.95rem; }
        .analise-toolbar select { padding:11px 14px;border:1px solid #d1d9e0;border-radius:8px;font-size:.9rem;background:#fff; }
        /* Modal deferimento */
        .modal-deferimento { background:#f0f9f0;border:1px solid #c3e6c3;border-radius:8px;padding:16px;margin-bottom:16px; }
        .modal-deferimento label { font-weight:600;font-size:.85rem;display:block;margin-bottom:4px;color:#155724; }
        .modal-deferimento input, .modal-deferimento select { width:100%;padding:9px 12px;border:1px solid #c3e6c3;border-radius:6px;font-size:.9rem;margin-bottom:10px; }
        /* Excluir card */
        .btn-excluir-card { background:#dc3545;color:#fff;border:none;border-radius:8px;padding:9px 14px;cursor:pointer;font-size:1rem;transition:.2s; }
        .btn-excluir-card:hover { background:#b02a37; }
    </style>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <div class="brand-area">
            <div class="brasao-container">
                <img src="img/Coat_of_arms_of_S√£o_Jos√©_do_Rio_Preto_SP.png" alt="Bras√£o" class="logo-dashboard">
            </div>
            <span>Portal SMS ‚Äî Admin</span>
        </div>
        <nav class="menu">
            <a href="#" class="menu-item active"  data-target="inicio">In√≠cio</a>
            <a href="#" class="menu-item"         data-target="perfil">Meu Perfil</a>
            <a href="#" class="menu-item"         data-target="faq">D√∫vidas</a>
            <a href="#" class="menu-item"         data-target="admin-pedidos">Gerenciar Pedidos</a>
            <a href="#" class="menu-item"         data-target="analise-pedidos">Analisar Pedidos</a>
            <a href="index.html" class="menu-item logout">Sair</a>
        </nav>
    </aside>

    <main class="main-content">
        <button class="mobile-menu-toggle" id="mobileMenuToggle"><span></span><span></span><span></span></button>

        <!-- IN√çCIO -->
        <section id="inicio" class="content-section active">
            <header class="section-header">
                <h1>Painel do Administrador</h1>
            </header>
            <div class="dashboard-grid">
                <div class="card status-card">
                    <h3>Minha Solicita√ß√£o</h3>
                    <div id="pedido-info"><p style="color:#888">Carregando...</p></div>
                </div>
                <div class="card rules-card">
                    <h3>Regras de Transfer√™ncia</h3>
                    <ul class="rules-list">
                        <li>Pedidos podem ser feitos uma vez a cada <strong>06 meses</strong>.</li>
                        <li>Pedido <strong>indeferido</strong> libera novo pedido imediatamente.</li>
                        <li>Ap√≥s transferido, perman√™ncia m√≠nima de <strong>01 ano</strong>.</li>
                        <li>Ao deferir, informe a data prevista de contempla√ß√£o.</li>
                        <li>Pedidos contemplados s√£o arquivados automaticamente no hist√≥rico.</li>
                    </ul>
                    <a href="img/portaria.pdf" target="_blank" class="link-documento">Ler Portaria Completa (PDF)</a>
                </div>
            </div>
        </section>

        <!-- PERFIL -->
        <section id="perfil" class="content-section">
            <header class="section-header"><h1>Meu Perfil</h1></header>
            <div class="card">
                <form id="updateProfileForm">
                    <div class="form-section-title">Dados Pessoais</div>
                    <div class="grid-row">
                        <div class="form-group"><label>Nome Completo</label><input type="text" id="edit-nome"></div>
                        <div class="form-group"><label>Matr√≠cula</label><input type="text" id="edit-matricula" placeholder="ex: 12345" readonly style="background:#f4f7f9"></div>
                    </div>
                    <div class="grid-row">
                        <div class="form-group"><label>E-mail</label><input type="email" id="edit-email"></div>
                        <div class="form-group"><label>Telefone</label><input type="tel" id="edit-telefone"></div>
                    </div>
                    <div class="form-section-title">Dados Profissionais</div>
                    <div class="grid-row">
                        <div class="form-group"><label>Cargo</label><select id="edit-cargo"><option value="" disabled>Selecione...</option></select></div>
                        <div class="form-group"><label>V√≠nculo</label>
                            <select id="vinculo">
                                <option value="" disabled selected>Selecione...</option>
                                <option value="Funfarme">Funfarme</option>
                                <option value="Prefeitura">Prefeitura</option>
                                <option value="Estadual">Estadual</option>
                                <option value="Federal">Federal</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid-row">
                        <div class="form-group"><label>Unidade de Lota√ß√£o</label><select id="edit-unidade"><option value="" disabled>Selecione...</option></select></div>
                        <div class="form-group"><label>Data de Admiss√£o</label><input type="date" id="edit-admissao"></div>
                    </div>
                    <hr class="divider">
                    <div class="form-section-title">Seguran√ßa</div>
                    <div class="grid-row">
                        <div class="form-group"><label>Nova Senha</label><input type="password" id="new-pass" placeholder="Deixe em branco para n√£o alterar"></div>
                        <div class="form-group"><label>Confirmar Senha</label><input type="password" id="confirm-new-pass" placeholder="Repita a nova senha"></div>
                    </div>
                    <div class="form-actions"><button type="submit" class="btn-secondary">Salvar Altera√ß√µes</button></div>
                </form>
            </div>
        </section>

        <!-- FAQ -->
        <section id="faq" class="content-section">
            <header class="section-header"><h1>Perguntas Frequentes</h1></header>
            <div class="faq-container">
                <div class="faq-item"><button class="faq-question">O que √© a data de contempla√ß√£o?</button><div class="faq-answer"><p>√â a data prevista em que o servidor ser√° efetivamente transferido para a unidade deferida. Quando essa data chega, o pedido √© arquivado automaticamente no hist√≥rico do servidor.</p></div></div>
                <div class="faq-item"><button class="faq-question">Servidor indeferido pode fazer novo pedido?</button><div class="faq-answer"><p>Sim. A regra dos 6 meses n√£o se aplica a pedidos indeferidos. O servidor pode solicitar novamente imediatamente ap√≥s o indeferimento.</p></div></div>
                <div class="faq-item"><button class="faq-question">Como funciona o hist√≥rico?</button><div class="faq-answer"><p>Pedidos contemplados (com data de contempla√ß√£o atingida) s√£o arquivados automaticamente. Tanto o servidor quanto o admin podem consultar o hist√≥rico completo de transfer√™ncias.</p></div></div>
            </div>
        </section>

        <!-- GERENCIAR PEDIDOS -->
        <section id="admin-pedidos" class="content-section">
            <header class="section-header">
                <div class="header-title">
                    <h1>Relat√≥rio de Pedidos de Transfer√™ncia</h1>
                    <p class="subtitle">Consulta t√©cnica e exporta√ß√£o do banco de dados</p>
                </div>
                <div class="header-actions">
                    <div class="export-group">
                        <button class="btn-action btn-excel" onclick="exportarRelatorio('xlsx')">‚¨á Excel</button>
                        <button class="btn-action btn-csv"   onclick="exportarRelatorio('csv')">‚¨á CSV</button>
                    </div>
                </div>
            </header>

            <div class="card table-toolbar">
                <div class="search-container">
                    <label class="filter-label">Busca R√°pida:</label>
                    <input type="text" id="dbSearch" placeholder="Nome, matr√≠cula, cargo, unidade, local solicitado..." onkeyup="debounceSearch()">
                </div>
                <div class="filter-group">
                    <div class="filter-item">
                        <label>Status:</label>
                        <select id="filterStatus" onchange="aplicarFiltros()">
                            <option value="todos">Todos</option>
                            <option value="Em An√°lise">Em An√°lise</option>
                            <option value="Deferido">Deferido</option>
                            <option value="Indeferido">Indeferido</option>
                            <option value="Contemplado">Contemplado</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>V√≠nculo:</label>
                        <select id="filterVinculo" onchange="aplicarFiltros()">
                            <option value="todos">Todos</option>
                            <option value="Funfarme">Funfarme</option>
                            <option value="Prefeitura">Prefeitura</option>
                            <option value="Estadual">Estadual</option>
                            <option value="Federal">Federal</option>
                        </select>
                    </div>
                    <div class="filter-item"><label>Cargo:</label><select id="filterCargo" onchange="aplicarFiltros()"><option value="todos">Todos</option></select></div>
                    <div class="filter-item"><label>Unidade Atual:</label><select id="filterUnidade" onchange="aplicarFiltros()"><option value="todos">Todas</option></select></div>
                    <div class="filter-item"><label>Local de Interesse:</label><select id="filterInteresse" onchange="aplicarFiltros()"><option value="todos">Todos</option></select></div>
                    <div class="filter-item">
                        <label>Per√≠odo:</label>
                        <div class="date-range">
                            <input type="date" id="filterDateStart" onchange="aplicarFiltros()">
                            <input type="date" id="filterDateEnd"   onchange="aplicarFiltros()">
                        </div>
                    </div>
                    <div class="filter-item highlight">
                        <label>Ordenar:</label>
                        <select id="orderData" onchange="aplicarFiltros()">
                            <option value="recente">Mais Novos</option>
                            <option value="antigo">Mais Antigos</option>
                            <option value="nomeAZ">Nome A-Z</option>
                            <option value="nomeZA">Nome Z-A</option>
                            <option value="matricula">Matr√≠cula</option>
                        </select>
                    </div>
                    <div class="filter-item"><label>&nbsp;</label><button class="btn-clear-filters" onclick="limparFiltros()">Limpar Filtros</button></div>
                </div>
            </div>

            <div class="card database-wrapper">
                <div class="table-info-bar">
                    <div class="selection-info"><span id="rowCount">0</span> registros encontrados</div>
                    <div class="bulk-actions" id="bulkActions" style="display:none;">
                        <button class="btn-bulk-delete" onclick="massaExcluir()">üóë Excluir Selecionados</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="db-table" id="deferidosTable">
                        <thead>
                            <tr>
                                <th class="col-check"><input type="checkbox" id="selectAll" onclick="toggleSelectAll()"></th>
                                <th>Nome</th><th>E-mail</th><th>Matr√≠cula</th><th>V√≠nculo</th>
                                <th>Cargo</th><th>Unidade Atual</th>
                                <th>Prioridade 1</th><th>Prioridade 2</th><th>Prioridade 3</th>
                                <th>Prioridade 4</th><th>Prioridade 5</th>
                                <th>Status</th><th>Data Pedido</th><th>Data Edi√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="dbContent"></tbody>
                    </table>
                </div>
                <div class="table-footer">
                    <div class="rows-per-page">Mostrar:
                        <select id="pageSize" onchange="mudarTamanhoPagina()">
                            <option value="15">15</option>
                            <option value="30">30</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="pagination-controls">
                        <span id="pageInfo">P√°gina 1 de 1</span>
                        <div class="pagination-btns">
                            <button class="btn-nav" id="prevPage" onclick="paginaAnterior()">&laquo;</button>
                            <div id="pageNumbers"></div>
                            <button class="btn-nav" id="nextPage" onclick="proximaPagina()">&raquo;</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ANALISAR PEDIDOS -->
        <section id="analise-pedidos" class="content-section">
            <header class="section-header">
                <div class="header-title">
                    <h1>Fila de An√°lise</h1>
                    <p class="subtitle">Avalia√ß√£o individual de solicita√ß√µes de transfer√™ncia</p>
                </div>
            </header>
            <div class="analise-toolbar">
                <input type="text" id="searchAnalise" placeholder="üîç  Nome, matr√≠cula, cargo, unidade, local solicitado..." onkeyup="debounceAnalise()">
                <select id="filterStatusAnalise" onchange="aplicarFiltrosAnalise()">
                    <option value="todos">Todos os Status</option>
                    <option value="Em An√°lise">Em An√°lise</option>
                    <option value="Deferido">Deferido</option>
                    <option value="Indeferido">Indeferido</option>
                    <option value="Contemplado">Contemplado</option>
                </select>
                <select id="orderAnalise" onchange="aplicarFiltrosAnalise()">
                    <option value="recente">Mais Novos primeiro</option>
                    <option value="antigo">Mais Antigos primeiro</option>
                </select>
            </div>
            <div id="cardsContainer" class="dashboard-grid"></div>
        </section>

        <!-- MODAL AN√ÅLISE -->
        <div id="modalDetalhes" class="modal-overlay" style="display:none;">
            <div class="modal-card">
                <header class="modal-header">
                    <h2>Detalhes da Solicita√ß√£o</h2>
                    <button class="btn-close" onclick="fecharModal()">&times;</button>
                </header>
                <div id="modalBody" class="modal-body"></div>
                <div class="modal-footer">
                    <!-- Campos de deferimento (mostrados ao deferir) -->
                    <div id="modalDeferimento" class="modal-deferimento" style="display:none;">
                        <label>üìÖ Data Prevista de Contempla√ß√£o *</label>
                        <input type="date" id="inputDataContemplacao">
                        <label>üè• Unidade Deferida (pode diferir das op√ß√µes)</label>
                        <input type="text" id="inputUnidadeDeferida" placeholder="Ex: UPA Norte">
                    </div>
                    <div class="justificativa-area">
                        <label for="justificativa">Justificativa (opcional):</label>
                        <textarea id="justificativa" placeholder="Digite o motivo da decis√£o..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button class="btn-status btn-analise"   onclick="atualizarStatus('Em An√°lise')">Manter em An√°lise</button>
                        <button class="btn-status btn-indeferir" onclick="atualizarStatus('Indeferido')">Indeferir</button>
                        <button class="btn-status btn-deferir"   onclick="document.getElementById('modalDeferimento').style.display='block'">Deferir ‚Üí</button>
                        <button class="btn-status btn-deferir"   id="btnConfirmarDefer" style="display:none" onclick="atualizarStatus('Deferido')">‚úÖ Confirmar Deferimento</button>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>
<script src="js/Api.config.js"></script>
<script src="js/dashboardAdminView.js"></script>
<script>
// Mostrar bot√£o de confirma√ß√£o quando √°rea de deferimento for aberta
document.addEventListener('DOMContentLoaded', () => {
    const btnDefer = document.querySelector('.btn-deferir');
    const btnConf  = document.getElementById('btnConfirmarDefer');
    const area     = document.getElementById('modalDeferimento');
    if (btnDefer && btnConf && area) {
        // Substituir onclick do primeiro btn-deferir
        document.querySelectorAll('.btn-deferir')[0].onclick = () => {
            area.style.display = 'block';
            btnConf.style.display = 'inline-block';
        };
    }
});
</script>
</body>
</html>